# mbtools

MSX 開発用のツール。以下のようなことができる。

- アセンブラソース以外のデータファイルからソースを生成
- `make`を使って差分ビルド
- ファイル監視して自動ビルド → エミュレータリロード

## 動作環境

- node.js >= 10
- アセンブラ: pasmo
- エミュレータ: openmsx

## インストール

```sh
$ npm install -g @gct256/mbtools
```

## 使い方

```sh
$ mkdir my-project
$ cd my-project
$ mbtools setup
$ make
$ make watch
```

## 主となるコマンド

### `mbtools config`

対話的に設定を作成します。
設定を作成しないと他のコマンドは動作しません。
設定は何回でも作ることができます。（上書きになります）

| 名前     | 役割                         | デフォルト | 備考                    |
| -------- | ---------------------------- | ---------- | ----------------------- |
| asm.type | 使用するアセンブラのタイプ   | `pasmo`    | 現時点では`pasmo`のみ   |
| asm.path | 使用するアセンブラのパス     |            | 現時点では`pasmo`のみ   |
| asm.ext  | アセンブラソースの拡張子     | `.asm`     |                         |
| emu.type | 使用するエミュレータのタイプ | `openmsx`  | 現時点では`openmsx`のみ |
| emu.path | 使用するエミュレータのパス   |            |                         |
| pp.ext   | 中間生成ファイルの拡張子     | `.inc`     |                         |
| dest.ext | 最終生成ファイルの拡張子     | `.rom`     |                         |

### `mbtools setup`

対話的にカレントディレクトリに Makefile を作成します。
Makefile 作成後は、`make`だけでビルドや監視、エミュレータリロードが行えます。

### その他のコマンド

Makefile から使うようになっているので通常は使用しません。

#### `mbtools watch`

カレントディレクトリのファイルを監視し、更新されたら make を実行します。
また、最終生成ファイルが更新された場合は自動的にエミュレータをリロードします。

#### `mbtools js2asm FILE EXT`

JavaScript の値をアセンブラソースに変換します。

- FILE: 対象のファイル
- EXT: 生成ファイルの拡張子

出力は対象のファイルと同じ場所に`EXT`で指定された拡張子を追加したものとなります。

- 例
  - FILE: foo/bar/baz.js
  - EXT: .inc
  - 生成ファイル → foo/bar/baz.js.inc

#### `mbtools png2asm FILE EXT`

PNG 画像をアセンブラソースに変換します。

- FILE: 対象のファイル
- EXT: 生成ファイルの拡張子

出力は対象のファイルと同じ場所に`EXT`で指定された拡張子を追加したものとなります。
また、一つの画像から複数のファイルが出力される場合は、追加する拡張子の前に独自の識別子が追加されたファイルとなります。

- 例
  - FILE: foo/bar/baz.png
  - EXT: .inc
  - 生成ファイル → foo/bar/baz.png.inc

変換方法は対象ファイルの末尾に応じて決定されます。

| 末尾                 | 変換方法                       | 補足                  |
| -------------------- | ------------------------------ | --------------------- |
| `.msx_sprite_8.png`  | 8x8 のビットパターン           |                       |
| `.msx_sprite_16.png` | 16x16 ビットパターン           |                       |
| `.msx_screen_2.png`  | 8x8 のビットパターンと色データ | ファイルが 2 つできる |

#### `mbtools shrink SIZE IN OUT`

ファイルのサイズを調整します。

- SIZE: サイズを KB で指定
- IN: 入力ファイル
- OUT: 出力ファイル

## TODO

- 対応アセンブラの追加: pasmo 以外を使いたくなったらやる
- 対応エミュレータの追加: openmsx 以外を使いたくなったらやる
